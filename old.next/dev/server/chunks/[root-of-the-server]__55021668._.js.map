{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/BMenez/Documents/Site/testsfy/src/lib/db.js"],"sourcesContent":["import { neon } from '@neondatabase/serverless';\r\n\r\nconst sql = neon(process.env.DATABASE_URL);\r\n\r\nexport default sql;\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,MAAM,IAAA,gKAAI,EAAC,QAAQ,GAAG,CAAC,YAAY;uCAE1B"}},
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/BMenez/Documents/Site/testsfy/src/app/api/get-user-totals/route.js"],"sourcesContent":["import sql from '@/lib/db';\r\n\r\nexport async function GET(req) {\r\n  try {\r\n\r\n    const url = new URL(req.url);\r\n    const id = Number(url.searchParams.get('id')) || 0;\r\n\r\n    let result;\r\n\r\n    if (id === 1) {\r\n      result = await sql`\r\n        SELECT\r\n            uss.name AS name,\r\n            COALESCE(SUM(uas.kilometers), 0)    AS kilometers,\r\n            COALESCE(SUM(uas.defit_amount), 0)  AS defit_amount,\r\n            COALESCE(SUM(uas.boost), 0)         AS boost\r\n        FROM users uss\r\n        LEFT JOIN user_activities uas\r\n          ON uas.user_id = uss.id\r\n        AND EXTRACT(YEAR FROM uas.date_claimed) = EXTRACT(YEAR FROM CURRENT_DATE)\r\n        GROUP BY uss.id, uss.name\r\n        ORDER BY uss.id;\r\n      `;\r\n    } else if (id === 2) {\r\n      result = await sql`\r\n        SELECT\r\n            uss.name AS name,\r\n            COALESCE(SUM(uas.kilometers), 0)    AS kilometers,\r\n            COALESCE(SUM(uas.defit_amount), 0)  AS defit_amount,\r\n            COALESCE(SUM(uas.boost), 0)         AS boost\r\n        FROM users uss\r\n        LEFT JOIN user_activities uas\r\n          ON uas.user_id = uss.id\r\n        AND EXTRACT(MONTH FROM uas.date_claimed) = EXTRACT(MONTH FROM CURRENT_DATE) AND EXTRACT(YEAR FROM uas.date_claimed) = EXTRACT(YEAR FROM CURRENT_DATE)\r\n        GROUP BY uss.id, uss.name\r\n        ORDER BY uss.id;  \r\n      `;\r\n    } else if (id === 3) {\r\n      result = await sql`\r\n        SELECT\r\n            uss.name AS name,\r\n            COALESCE(SUM(uas.kilometers), 0)    AS kilometers,\r\n            COALESCE(SUM(uas.defit_amount), 0)  AS defit_amount,\r\n            COALESCE(SUM(uas.boost), 0)         AS boost\r\n        FROM users uss\r\n        LEFT JOIN user_activities uas\r\n          ON uas.user_id = uss.id\r\n        AND EXTRACT(WEEK FROM uas.date_claimed) = EXTRACT(WEEK FROM CURRENT_DATE) AND EXTRACT(MONTH FROM uas.date_claimed) = EXTRACT(MONTH FROM CURRENT_DATE) AND EXTRACT(YEAR FROM uas.date_claimed) = EXTRACT(YEAR FROM CURRENT_DATE)\r\n        GROUP BY uss.id, uss.name\r\n        ORDER BY uss.id;    \r\n      `;\r\n    }\r\n    else {\r\n      result = await sql`\r\n        SELECT\r\n            uss.name AS name,\r\n            COALESCE(SUM(uas.kilometers), 0)    AS kilometers,\r\n            COALESCE(SUM(uas.defit_amount), 0)  AS defit_amount,\r\n            COALESCE(SUM(uas.boost), 0)         AS boost\r\n        FROM users uss\r\n        LEFT JOIN user_activities uas\r\n          ON uas.user_id = uss.id\r\n        GROUP BY uss.id, uss.name\r\n        ORDER BY uss.id;\r\n      `;\r\n    }\r\n\r\n    const response = result.map(row => ({\r\n      name: row.name,\r\n      kilometers: Number(row.kilometers ?? 0),\r\n      defit_amount: Number(row.defit_amount ?? 0),\r\n      boost: Number(row.boost ?? 0),\r\n    }));\r\n\r\n    return new Response(JSON.stringify(response), {\r\n      status: 200,\r\n      headers: { 'Content-Type': 'application/json' },\r\n    });\r\n  } catch (err) {\r\n    console.error('❌ DB error:', err);\r\n    return new Response(\r\n      JSON.stringify({ euros: 0, defits: 0, error: err.message }),\r\n      {\r\n        status: 500,\r\n        headers: { 'Content-Type': 'application/json' },\r\n      }\r\n    );\r\n  }\r\n}\r\n\r\n// SELECT \r\n//     COALESCE(t.value1, 0) AS value1,\r\n//     uas.*\r\n// FROM user_activities uas\r\n// LEFT JOIN LATERAL (\r\n//     SELECT uts.value1\r\n//     FROM user_transactions uts\r\n//     WHERE uts.user_id = uas.user_id\r\n//       AND uts.transaction_date > uas.date_claimed  -- prochaine transaction\r\n//     ORDER BY uts.transaction_date ASC             -- la plus proche après\r\n//     LIMIT 1\r\n// ) t ON TRUE\r\n// WHERE uas.user_id = 1\r\n// ORDER BY uas.date_claimed ASC;\r\n\r\n// SELECT \r\n//     COALESCE(t.value1, -1) AS value1,\r\n//     COALESCE(t.value2, -1) AS value2,\r\n//     CASE \r\n//         WHEN t.value1 IS NULL OR t.value1 = 0 THEN NULL\r\n//         ELSE t.value2 / t.value1\r\n//     END AS ratio,\r\n//     uas.*\r\n// FROM user_activities uas\r\n// LEFT JOIN LATERAL (\r\n//     SELECT \r\n//         uts.value1,\r\n//         uts.value2\r\n//     FROM user_transactions uts\r\n//     WHERE uts.user_id = uas.user_id\r\n//       AND uts.transaction_date > uas.date_claimed\r\n//     ORDER BY uts.transaction_date ASC\r\n//     LIMIT 1\r\n// ) t ON TRUE\r\n// WHERE uas.user_id = 1\r\n// ORDER BY uas.date_claimed ASC;\r\n"],"names":[],"mappings":";;;;AAAA;;AAEO,eAAe,IAAI,GAAG;IAC3B,IAAI;QAEF,MAAM,MAAM,IAAI,IAAI,IAAI,GAAG;QAC3B,MAAM,KAAK,OAAO,IAAI,YAAY,CAAC,GAAG,CAAC,UAAU;QAEjD,IAAI;QAEJ,IAAI,OAAO,GAAG;YACZ,SAAS,MAAM,6HAAG,CAAC;;;;;;;;;;;;MAYnB,CAAC;QACH,OAAO,IAAI,OAAO,GAAG;YACnB,SAAS,MAAM,6HAAG,CAAC;;;;;;;;;;;;MAYnB,CAAC;QACH,OAAO,IAAI,OAAO,GAAG;YACnB,SAAS,MAAM,6HAAG,CAAC;;;;;;;;;;;;MAYnB,CAAC;QACH,OACK;YACH,SAAS,MAAM,6HAAG,CAAC;;;;;;;;;;;MAWnB,CAAC;QACH;QAEA,MAAM,WAAW,OAAO,GAAG,CAAC,CAAA,MAAO,CAAC;gBAClC,MAAM,IAAI,IAAI;gBACd,YAAY,OAAO,IAAI,UAAU,IAAI;gBACrC,cAAc,OAAO,IAAI,YAAY,IAAI;gBACzC,OAAO,OAAO,IAAI,KAAK,IAAI;YAC7B,CAAC;QAED,OAAO,IAAI,SAAS,KAAK,SAAS,CAAC,WAAW;YAC5C,QAAQ;YACR,SAAS;gBAAE,gBAAgB;YAAmB;QAChD;IACF,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,eAAe;QAC7B,OAAO,IAAI,SACT,KAAK,SAAS,CAAC;YAAE,OAAO;YAAG,QAAQ;YAAG,OAAO,IAAI,OAAO;QAAC,IACzD;YACE,QAAQ;YACR,SAAS;gBAAE,gBAAgB;YAAmB;QAChD;IAEJ;AACF,EAEA,UAAU;CACV,uCAAuC;CACvC,YAAY;CACZ,2BAA2B;CAC3B,sBAAsB;CACtB,wBAAwB;CACxB,iCAAiC;CACjC,sCAAsC;CACtC,8EAA8E;CAC9E,4EAA4E;CAC5E,cAAc;CACd,cAAc;CACd,wBAAwB;CACxB,iCAAiC;CAEjC,UAAU;CACV,wCAAwC;CACxC,wCAAwC;CACxC,YAAY;CACZ,0DAA0D;CAC1D,mCAAmC;CACnC,oBAAoB;CACpB,YAAY;CACZ,2BAA2B;CAC3B,sBAAsB;CACtB,cAAc;CACd,sBAAsB;CACtB,qBAAqB;CACrB,iCAAiC;CACjC,sCAAsC;CACtC,oDAAoD;CACpD,wCAAwC;CACxC,cAAc;CACd,cAAc;CACd,wBAAwB;CACxB,iCAAiC"}}]
}